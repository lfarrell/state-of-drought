queue().defer(d3.json,"js/us-states.json").defer(d3.csv,"state_centers_abbr.csv").defer(d3.csv,"all_state.csv").await(function(k,r,u,n){function v(a){if(!document.querySelectorAll(a+" svg").length){var h=_.range(3,25,5),b=[60,80,110,150,200];a=d3.select(a).append("svg").attr("width",350).attr("height",55).attr("class","legend").translate([35,0]);a.append("text").attr("x",1).attr("y",35).attr("height",30).attr("width",25).text("Smaller");a.selectAll("g").data(h).enter().append("g").attr("width",350).each(function(a,c){d3.select(this).append("circle").attr("cx",b[c]).attr("cy",15).attr("r",function(a){return a}).translate([0,15])});a.append("text").attr("x",233).attr("y",35).attr("height",30).attr("width",25).text("Greater")}}function w(a,h){if(!document.querySelectorAll(a+" svg").length){var b=10;d3.select(a).append("svg").attr("width",600).attr("height",55).attr("class","legend").selectAll("g").data(["Abnormally Dry (D0)","Moderate (D1)","Severe (D2)","Extreme (D3)","Exceptional (D4)"]).enter().append("g").attr("width",600).each(function(a,c){var e=d3.select(this);e.attr("class",h[c]+" legend_value");e.append("rect").attr("x",b).attr("y",15).attr("width",10).attr("height",10).style("fill",h[c]);e.append("text").attr("x",b+15).attr("y",25).attr("height",30).attr("width",50*a.length).text(a);b+=5*a.length+(0==c?55:45)})}}function x(a){if(!document.querySelectorAll("#circ_legend svg").length){for(var h=_.range(5,35,5).reverse(),b=d3.select("#circ_legend").append("svg").attr("width",325).attr("height",100).append("g").attr("class",
    "color-legend").translate([35,25]),g=0;5>g;g++)b.append("circle").attr("cx",50).attr("cy",15).attr("r",function(a){return h[g]}).style("stroke",function(b){return a[g]});b=d3.swoopyDrag().x(function(a){return a.xVal}).y(function(a){return a.yVal}).draggable(0);b.annotations([{xVal:125,yVal:100,path:"M-30,-89L5,-89",text:"Abnormally Dry (D0)",textOffset:[11,-85]},{xVal:125,yVal:100,path:"M-18,-71L3,-71",text:"Moderate Drought (D1)",textOffset:[11,-65]},{xVal:125,yVal:100,path:"M-21,-61L3,-52",text:"Severe Drought (D2)",
    textOffset:[11,-45]},{xVal:125,yVal:100,path:"M-26,-56L4,-34",text:"Extreme Drought (D3)",textOffset:[11,-25]},{xVal:125,yVal:100,path:"M-36,-51L5,-14",text:"Exceptional Drought (D4)",textOffset:[11,-5]}]);d3.select("#circ_legend svg").append("g.annotations").call(b)}}var y=d3.time.format("%m-%y").parse,p=["#ffffd4","#fed98e","#fe9929","#d95f0e","#993404"],z={AL:"Alabama",AZ:"Arizona",AR:"Arkansas",CA:"California",CO:"Colorado",CT:"Connecticut",DE:"Delaware",FL:"Florida",GA:"Georgia",ID:"Idaho",IL:"Illinois",
    IN:"Indiana",IA:"Iowa",KS:"Kansas",KY:"Kentucky",LA:"Louisiana",ME:"Maine",MD:"Maryland",MA:"Massachusetts",MI:"Michigan",MN:"Minnesota",MS:"Mississippi",MO:"Missouri",MT:"Montana",NE:"Nebraska",NV:"Nevada",NH:"New Hampshire",NJ:"New Jersey",NM:"New Mexico",NY:"New York",NC:"North Carolina",ND:"North Dakota",OH:"Ohio",OK:"Oklahoma",OR:"Oregon",PA:"Pennsylvania",RI:"Rhode Island",SC:"South Carolina",SD:"South Dakota",TN:"Tennessee",TX:"Texas",UT:"Utah",VT:"Vermont",VA:"Virginia",WA:"Washington",WV:"West Virginia",
    WI:"Wisconsin",WY:"Wyoming"},q=d3.select("body").append("div").attr("class","tooltip").style("opacity",0),A=d3.select("#date-text");n.forEach(function(a){a.date=y(a.month+"-"+a.year)});var t=d3.select("#map").append("svg").attr("vector-effect","non-scaling-stroke").append("g").attr("id","base_map"),m=chroniton().domain(d3.extent(n,function(a){return a.date})).labelFormat(d3.time.format("%m-%Y")).height(75).playbackRate(.45);k=_.debounce(function(){function a(a,b){return _.find(a,function(a){return b.state===
    a.state})}function h(b,c){function d(a){return 100==a?100:a}c.on("mouseover touchstart",function(c){c=a(b,c);q.transition().duration(100).style("opacity",.9);q.html('<h4 class="text-center">'+z[c.state]+'</h4><h5  class="text-center">Drought Levels (% of state)</h5><div class="row"><div class="col-md-6"><ul class="list-unstyled first"><li>D0: '+d(c.D0)+"%</li><li>D1: "+d(c.D1)+"%</li><li>D2: "+d(c.D2)+'%</li></ul></div><div class="col-md-6"><ul class="list-unstyled last"><li>D3: '+d(c.D3)+"%</li><li>D4: "+
    d(c.D4)+"%</li></ul></div></div>").style("top",d3.event.pageY+18+"px").style("left",d3.event.pageX-15+"px")}).on("mouseout touchend",function(a){q.transition().duration(250).style("opacity",0)})}var b=window.innerHeight,g=window.innerWidth-20-20;m.width(g).on("change",function(b){var c=b.getMonth()+1,d=10>c?"0"+c:c,g=b.getFullYear().toString().substr(2),e=n.filter(function(a){return a.year==g&&a.month==d});A.transition().duration(200).ease("sin-in-out").text("January February March April May June July August September October November December".split(" ")[parseInt(e[0].month,
    10)-1]+" 20"+e[0].year);for(var f=0;5>f;f++)b=d3.selectAll(".level_"+f),b.transition().duration(200).ease("sin-in-out").attr("r",function(b){var c=f;return.2*a(e,b)["D"+c]}),h(e,b)});d3.select("#play").on("click",function(){m.play()});d3.select("#pause").on("click",function(){m.pause()});d3.select("#stop").on("click",function(){m.stop()});d3.select("#slider").call(m);var c=1,e=d3.geo.albersUsa().scale(c).translate([0,0]),f=d3.geo.path().projection(e),d=f.bounds(r),c=.95/Math.max((d[1][0]-d[0][0])/
    g,(d[1][1]-d[0][1])/b),d=[(g-c*(d[1][0]+d[0][0]))/2,(b-c*(d[1][1]+d[0][1]))/2],e=d3.geo.albersUsa().scale(c).translate(d),f=f.projection(e);d3.select("#map svg").attr("height",b).attr("width",g);b=t.selectAll("path").data(r.features);b.enter().append("path");b.attr("d",f);b.exit().remove();var k=n.filter(function(a){return"00"==a.year&&"01"==a.month});d3.selectAll("#map circle").remove();for(var f=t.selectAll("circle").data(u),l=0;5>l;l++)f.enter().append("circle"),f.attr("class","level_"+l).attr("cx",function(a){return e([a.lng,a.lat])[0]}).attr("cy",function(a){return e([a.lng,a.lat])[1]}).attr("r",function(b){var c=l;return.2*a(k,b)["D"+c]}).style("stroke",p[l]),b=d3.selectAll("circle.level_"+l),h(k,b);f.exit().remove();v("#pct_legend");w("#color_legend",p);x(p);d3.selectAll(".row").classed("hide",!1);d3.selectAll("#load").classed("hide",!0)},400);k();window.addEventListener("resize",k)});