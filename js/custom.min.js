queue().defer(d3.json,"js/us-states.json").defer(d3.csv,"state_centers_abbr.csv").defer(d3.csv,"all_state.csv").await(function(l,u,x,m){function v(b){switch(parseInt(b)){case 12:case 1:case 2:return"winter";case 3:case 4:case 5:return"spring";case 6:case 7:case 8:return"summer";case 9:case 10:case 11:return"fall";default:return"unknown"}}function y(b){if(!document.querySelectorAll(b+" svg").length){var h=_.range(3,25,5),f=[60,80,110,150,200];b=d3.select(b).append("svg").attr("width",350).attr("height",
    55).attr("class","legend").translate([35,0]);b.append("text").attr("x",1).attr("y",35).attr("height",30).attr("width",25).text("Smaller");b.selectAll("g").data(h).enter().append("g").attr("width",350).each(function(b,g){d3.select(this).append("circle").attr("cx",f[g]).attr("cy",15).attr("r",function(b){return b}).translate([0,15])});b.append("text").attr("x",233).attr("y",35).attr("height",30).attr("width",25).text("Greater")}}function z(b,h){if(!document.querySelectorAll(b+" svg").length){var f=
    10;d3.select(b).append("svg").attr("width",600).attr("height",55).attr("class","legend").selectAll("g").data(["Abnormally Dry (D0)","Moderate (D1)","Severe (D2)","Extreme (D3)","Exceptional (D4)"]).enter().append("g").attr("width",600).each(function(b,g){var k=d3.select(this);k.attr("class",h[g]+" legend_value");k.append("rect").attr("x",f).attr("y",15).attr("width",10).attr("height",10).style("fill",h[g]);k.append("text").attr("x",f+15).attr("y",25).attr("height",30).attr("width",50*b.length).text(b);
    f+=5*b.length+(0==g?55:45)})}}function A(b){if(!document.querySelectorAll("#circ_legend svg").length){for(var h=_.range(5,35,5).reverse(),f=d3.select("#circ_legend").append("svg").attr("width",325).attr("height",100).attr("class","legend").translate([35,20]),c=0;5>c;c++)f.append("circle").attr("cx",50).attr("cy",15).attr("r",function(b){return h[c]}).style("stroke",function(g){return b[c]});f=d3.swoopyDrag().x(function(b){return b.xVal}).y(function(b){return b.yVal}).draggable(0);f.annotations([{xVal:125,
    yVal:100,path:"M-58,-109L5,-108",text:"Abnormally Dry (D0)",textOffset:[9,-103]},{xVal:125,yVal:100,path:"M-53,-97L6,-95",text:"Moderate Drought (D1)",textOffset:[9,-88]},{xVal:125,yVal:100,path:"M-55,-89L4,-80",text:"Severe Drought (D2)",textOffset:[9,-73]},{xVal:125,yVal:100,path:"M-61,-84L4,-65",text:"Extreme Drought (D3)",textOffset:[9,-58]},{xVal:125,yVal:100,path:"M-71,-76L3,-51",text:"Exceptional Drought (D4)",textOffset:[9,-43]}]);d3.select("#circ_legend svg").append("g.annotations").call(f)}}
    var B=d3.time.format("%m-%y").parse,r=["#ffffd4","#fed98e","#fe9929","#d95f0e","#993404"],C={AL:"Alabama",AZ:"Arizona",AR:"Arkansas",CA:"California",CO:"Colorado",CT:"Connecticut",DE:"Delaware",FL:"Florida",GA:"Georgia",ID:"Idaho",IL:"Illinois",IN:"Indiana",IA:"Iowa",KS:"Kansas",KY:"Kentucky",LA:"Louisiana",ME:"Maine",MD:"Maryland",MA:"Massachusetts",MI:"Michigan",MN:"Minnesota",MS:"Mississippi",MO:"Missouri",MT:"Montana",NE:"Nebraska",NV:"Nevada",NH:"New Hampshire",NJ:"New Jersey",NM:"New Mexico",
        NY:"New York",NC:"North Carolina",ND:"North Dakota",OH:"Ohio",OK:"Oklahoma",OR:"Oregon",PA:"Pennsylvania",RI:"Rhode Island",SC:"South Carolina",SD:"South Dakota",TN:"Tennessee",TX:"Texas",UT:"Utah",VT:"Vermont",VA:"Virginia",WA:"Washington",WV:"West Virginia",WI:"Wisconsin",WY:"Wyoming"},t=d3.select("body").append("div").attr("class","tooltip").style("opacity",0),D=d3.select("#date-text");m.forEach(function(b){b.date=B(b.month+"-"+b.year);b.season=v(b.month)});var w=d3.select("#map").append("svg").attr("vector-effect",
        "non-scaling-stroke").append("g").attr("id","base_map"),p=chroniton().domain(d3.extent(m,function(b){return b.date})).labelFormat(d3.time.format("%m-%Y")).height(75).playbackRate(.45);l=_.debounce(function(){function b(a){return{nothing:d3.mean(a,function(a){return a.nothing}),D0:d3.mean(a,function(a){return a.D0}),D1:d3.mean(a,function(a){return a.D1}),D2:d3.mean(a,function(a){return a.D2}),D3:d3.mean(a,function(a){return a.D3}),D4:d3.mean(a,function(a){return a.D4})}}function h(a,b){return _.find(a,
        function(a){return b.state===a.state})}function f(a,b){function c(a){return 100==a?100:a}b.on("mouseover touchstart",function(b){b=h(a,b);t.transition().duration(100).style("opacity",.9);t.html('<h4 class="text-center">'+C[b.state]+'</h4><h5  class="text-center">Drought Levels (% of state)</h5><div class="row"><div class="col-md-6"><ul class="list-unstyled first"><li>D0: '+c(b.D0)+"%</li><li>D1: "+c(b.D1)+"%</li><li>D2: "+c(b.D2)+'%</li></ul></div><div class="col-md-6"><ul class="list-unstyled last"><li>D3: '+
        c(b.D3)+"%</li><li>D4: "+c(b.D4)+"%</li></ul></div></div>").style("top",d3.event.pageY+18+"px").style("left",d3.event.pageX-15+"px")}).on("mouseout touchend",function(a){t.transition().duration(250).style("opacity",0)})}var c=window.innerHeight,g=window.innerWidth-20-20;p.width(g).on("change",function(a){var b=a.getMonth()+1,c=10>b?"0"+b:b,g=a.getFullYear().toString().substr(2),d=m.filter(function(a){return a.year==g&&a.month==c});D.transition().duration(200).ease("sin-in-out").text("January February March April May June July August September October November December".split(" ")[parseInt(d[0].month,
        10)-1]+" 20"+d[0].year);for(var e=0;5>e;e++)a=d3.selectAll(".level_"+e),a.transition().duration(200).ease("sin-in-out").attr("r",function(a){var b=e;return.2*h(d,a)["D"+b]}),f(d,a)});d3.select("#play").on("click",function(){p.play()});d3.select("#pause").on("click",function(){p.pause()});d3.select("#stop").on("click",function(){p.stop()});d3.select("#slider").call(p);var k=1,q=d3.geo.albersUsa().scale(k).translate([0,0]),d=d3.geo.path().projection(q),e=d.bounds(u),k=.95/Math.max((e[1][0]-e[0][0])/
        g,(e[1][1]-e[0][1])/c),e=[(g-k*(e[1][0]+e[0][0]))/2,(c-k*(e[1][1]+e[0][1]))/2],q=d3.geo.albersUsa().scale(k).translate(e),d=d.projection(q);d3.select("#map svg").attr("height",c).attr("width",g);c=w.selectAll("path").data(u.features);c.enter().append("path");c.attr("d",d);c.exit().remove();var l=m.filter(function(a){return"00"==a.year&&"01"==a.month});d3.selectAll("#map circle").remove();for(var d=w.selectAll("circle").data(x),n=0;5>n;n++)d.enter().append("circle"),d.attr("class","level_"+n).attr("cx",
        function(a){return q([a.lng,a.lat])[0]}).attr("cy",function(a){return q([a.lng,a.lat])[1]}).attr("r",function(a){var b=n;return.2*h(l,a)["D"+b]}).style("stroke",r[n]),c=d3.selectAll("circle.level_"+n),f(l,c);d.exit().remove();y("#pct_legend");z("#color_legend",r);A(r);m.filter(function(a){return"us_all"===a.state}).forEach(function(a){a.season=v(a.month)});d=m.filter(function(a){return"CA"===a.state});d3.nest().key(function(a){return a.month}).rollup(function(a){return b(a)}).entries(d)},400);l();
    window.addEventListener("resize",l);d3.selectAll(".row").classed("hide",!1);d3.selectAll("#load").classed("hide",!0)});